<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Scrutini - Istituto Professionale Mendel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-gradient-start: #0f172a;
            --bg-gradient-mid: #172554;
            --bg-gradient-end: #1e40af;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --header-bg: rgba(30, 64, 175, 0.9);
            
            /* Buttons */
            --btn-bg: #4f46e5;
            --btn-text: #ffffff;
            --btn-hover: #4338ca;
        }

        body.light-mode {
            /* Light Theme */
            --bg-gradient-start: #f8fafc;
            --bg-gradient-mid: #e2e8f0;
            --bg-gradient-end: #cbd5e1;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(203, 213, 225, 0.6);
            --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --header-bg: rgba(255, 255, 255, 0.95);
            
            /* Buttons Light Mode */
            --btn-bg: #2563eb;
            --btn-text: #ffffff;
            --btn-hover: #1d4ed8;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.5s ease, border-color 0.5s ease;
        }

        .glass-panel.interactive:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            cursor: pointer;
        }

        .glass-header {
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.3s ease;
        }

        /* Typography overrides for themes */
        h2, h3, h4, strong { color: var(--text-main) !important; }
        p, span { color: var(--text-main); }
        .text-muted { color: var(--text-muted) !important; }
        
        /* Specific overrides */
        body.light-mode .text-blue-300 { color: #1e40af !important; } /* Darker blue for light mode */
        body.light-mode .text-blue-400 { color: #2563eb !important; }
        
        /* Buttons */
        .action-btn {
            background-color: var(--btn-bg);
            color: var(--btn-text);
            transition: background-color 0.2s;
        }
        .action-btn:hover { background-color: var(--btn-hover); }

        .theme-toggle-btn {
            background-color: rgba(128, 128, 128, 0.2);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
        }
        .theme-toggle-btn:hover { background-color: rgba(128, 128, 128, 0.4); }

        .dropdown-menu { display: none; background-color: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        .dropdown-open .dropdown-menu { display: block; }
        .dropdown-item { color: var(--text-main); }
        .dropdown-item:hover { background-color: rgba(128,128,128,0.1); }

        @media print {
            body { background: white; color: black; }
            .glass-panel { background: white; border: 1px solid #ddd; box-shadow: none; color: black; break-inside: avoid; transform: none !important; }
            .no-print { display: none !important; }
            .highcharts-container { width: 100% !important; height: auto !important; }
            .break-before-page { page-break-before: always; }
        }

        .drag-active {
            border-color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.2) !important;
            transform: scale(1.02);
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
    </style>
</head>
<body>

    <header class="glass-header fixed w-full top-0 z-50 transition-all duration-300 shadow-xl">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-blue-900 text-2xl shadow-lg">
                    <i class="fas fa-microscope"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">IIS MENDEL</h1>
                    <p class="text-sm font-semibold uppercase tracking-widest opacity-80">Istituto Professionale</p>
                </div>
            </div>
            <div class="no-print flex gap-3 items-center">
                
                <button onclick="toggleTheme()" class="theme-toggle-btn w-10 h-10 rounded-full flex items-center justify-center transition shadow-sm" title="Cambia Tema">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>

                <button onclick="window.print()" class="action-btn items-center px-4 py-2 rounded-lg text-sm font-semibold transition shadow-lg hidden" id="print-btn">
                    <i class="fas fa-print mr-2"></i> Stampa
                </button>

                <div class="relative dropdown hidden" id="save-btn-container">
                    <button onclick="toggleDropdown(event)" class="action-btn items-center px-4 py-2 rounded-lg text-sm font-semibold transition shadow-lg flex focus:outline-none">
                        <i class="fas fa-save mr-2"></i> Salva come <i class="fas fa-chevron-down ml-2"></i>
                    </button>
                    <div id="dropdown-menu" class="dropdown-menu absolute right-0 mt-2 w-56 rounded-md shadow-lg py-1 z-50">
                        <a href="#" onclick="exportHTML(); closeDropdown()" class="dropdown-item block px-4 py-2 text-sm font-bold border-b border-gray-500/20"><i class="fas fa-code mr-2 text-indigo-500"></i> Pagina Web (.html)</a>
                        <a href="#" onclick="exportDOCX(); closeDropdown()" class="dropdown-item block px-4 py-2 text-sm"><i class="fas fa-file-word mr-2 text-blue-500"></i> Word (.docx)</a>
                        <a href="#" onclick="exportXLSX(); closeDropdown()" class="dropdown-item block px-4 py-2 text-sm"><i class="fas fa-file-excel mr-2 text-green-500"></i> Excel (.xlsx)</a>
                        <a href="#" onclick="exportCSV(); closeDropdown()" class="dropdown-item block px-4 py-2 text-sm"><i class="fas fa-file-csv mr-2 text-green-700"></i> CSV (.csv)</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 pt-32 pb-12">

        <div id="intro-hero" class="text-center max-w-4xl mx-auto mb-16 transition-all duration-500">
            <h2 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-300 via-cyan-200 to-white animate-in" style="animation-delay: 0s;">
                Dashboard Scrutini (Professionale)
            </h2>
            <p class="text-xl mb-10 animate-in leading-relaxed opacity-90" style="animation-delay: 0.1s;">
                Per generare il report, trascina qui sotto i file <strong>Excel (.xlsx)</strong> delle classi.<br>
                <span class="text-blue-300 font-bold text-sm">Analisi Intelligente: unisce automaticamente i file spezzati.</span>
            </p>

            <div id="drop-zone" class="glass-panel rounded-3xl p-16 text-center border-4 border-dashed border-blue-500/30 hover:border-blue-400 transition-all cursor-pointer group animate-in relative overflow-hidden" style="animation-delay: 0.2s;">
                <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"></div>
                
                <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-2xl z-10 relative pulse-ring">
                    <i class="fas fa-file-excel text-5xl text-white"></i>
                </div>
                
                <h3 class="text-3xl font-bold mb-4 relative z-10">Trascina qui i file EXCEL</h3>
                <p class="text-lg mb-8 relative z-10 opacity-80">Accetta file multipli (.xlsx, .csv)</p>
                
                <input type="file" id="file-input" multiple accept=".xlsx, .xls, .csv" class="hidden">
                <button onclick="document.getElementById('file-input').click()" class="relative z-10 px-10 py-4 bg-white text-blue-900 rounded-full font-bold text-lg shadow-xl hover:scale-105 transition-transform">
                    Seleziona File
                </button>
                <p id="error-msg" class="text-red-400 mt-6 hidden text-lg font-bold bg-red-900/50 p-2 rounded-lg"></p>
                <p id="success-msg" class="text-blue-300 mt-6 hidden text-lg font-bold bg-blue-900/50 p-2 rounded-lg"></p>
            </div>
        </div>

        <div id="report-content" class="hidden space-y-12">
            
            <div class="text-center mb-12 animate-in">
                <h2 class="text-4xl font-extrabold">Analisi Risultati Primo Quadrimestre</h2>
                <p class="text-lg mt-2 opacity-80">Anno Scolastico 2025/2026 - Istituto Professionale</p>
                <div class="no-print mt-4 p-4 bg-white/5 rounded-xl border border-white/10 max-w-3xl mx-auto">
                    <span class="text-sm font-bold block mb-2 uppercase tracking-widest opacity-70">Stato Acquisizione Dati:</span>
                    <div id="analyzed-classes" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-left"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 animate-in" style="animation-delay: 0.1s;">
                <div class="glass-panel interactive p-8 rounded-3xl relative overflow-hidden group">
                    <div class="absolute -right-8 -top-8 text-9xl opacity-5 rotate-12"><i class="fas fa-users"></i></div>
                    <p class="text-sm font-bold uppercase tracking-widest mb-2 opacity-70">Totale Alunni</p>
                    <h3 class="text-6xl font-extrabold" id="stat-total-students">0</h3>
                </div>
                <div class="glass-panel interactive p-8 rounded-3xl relative overflow-hidden group border-blue-500/30">
                    <div class="absolute -right-8 -top-8 text-9xl text-blue-500/10 rotate-12"><i class="fas fa-check-circle"></i></div>
                    <p class="text-blue-300 font-bold uppercase text-sm tracking-widest mb-2">Senza Debiti</p>
                    <h3 class="text-6xl font-extrabold text-blue-400" id="stat-clean-students">0</h3>
                    <div class="mt-2 text-sm opacity-60" id="perc-clean">0% del totale</div>
                </div>
                <div class="glass-panel interactive p-8 rounded-3xl relative overflow-hidden group border-red-500/30">
                    <div class="absolute -right-8 -top-8 text-9xl text-red-500/10 rotate-12"><i class="fas fa-exclamation-triangle"></i></div>
                    <p class="text-red-400 font-bold uppercase text-sm tracking-widest mb-2">Con Insufficienze</p>
                    <h3 class="text-6xl font-extrabold text-red-400" id="stat-debt-students">0</h3>
                    <div class="mt-2 text-sm opacity-60" id="perc-debt">0% del totale</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 animate-in" style="animation-delay: 0.2s;">
                <div class="glass-panel p-8 rounded-3xl" id="container-chart-parallel">
                    <h3 class="text-2xl font-bold mb-8 flex items-center">
                        <span class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center mr-4 text-blue-400 shadow-inner"><i class="fas fa-layer-group"></i></span>
                        Andamento Classi Parallele
                    </h3>
                    <div id="chart-parallel" style="height: 450px; width: 100%;"></div>
                </div>

                <div class="glass-panel p-8 rounded-3xl" id="container-chart-classes">
                    <h3 class="text-2xl font-bold mb-8 flex items-center">
                        <span class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center mr-4 text-blue-400 shadow-inner"><i class="fas fa-chalkboard-teacher"></i></span>
                        Dettaglio per Classe (N. Studenti)
                    </h3>
                    <div id="chart-classes" style="height: 450px; width: 100%;"></div>
                </div>
            </div>

            <div class="animate-in break-before-page" style="animation-delay: 0.25s;">
                <h3 class="text-3xl font-bold mb-8 flex items-center border-b border-gray-500/20 pb-4 mt-16">
                   <i class="fas fa-chart-bar text-cyan-400 mr-4"></i>Analisi Materie per Classi Parallele
               </h3>
               <p class="mb-8 -mt-6 text-sm opacity-70">Totale insufficienze per materia aggregate per anno di corso. Clicca per zoom.</p>
               
               <div id="parallel-subjects-container" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
               </div>
           </div>

            <div class="animate-in break-before-page" style="animation-delay: 0.3s;">
                 <h3 class="text-3xl font-bold mb-8 flex items-center border-b border-gray-500/20 pb-4 mt-16">
                    <i class="fas fa-chart-pie text-indigo-400 mr-4"></i>Dettaglio Insufficienze per Materia (Singola Classe)
                </h3>
                <p class="mb-8 -mt-6 text-sm opacity-70">Grafici generati automaticamente per ogni singola classe analizzata. Clicca per zoom.</p>
                
                <div id="subject-charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                </div>
            </div>

            <div class="animate-in break-before-page" style="animation-delay: 0.35s;">
                <h3 class="text-3xl font-bold mb-8 flex items-center border-b border-gray-500/20 pb-4 mt-16">
                    <i class="fas fa-percentage text-green-400 mr-4"></i>Percentuale Insufficienze per Materia (Totale Professionale)
                </h3>
                <p class="mb-8 -mt-6 text-sm opacity-70">Incidenza percentuale delle insufficienze calcolata sul totale degli alunni elaborati in tutte le classi del Professionale.</p>
                
                <div class="glass-panel p-8 rounded-3xl">
                    <div id="chart-perc-materie" style="height: 550px; width: 100%;"></div>
                </div>
            </div>

            <div class="glass-panel p-10 rounded-3xl animate-in border-t-4 border-t-yellow-500 mt-12 break-before-page" style="animation-delay: 0.4s;">
                <h3 class="text-3xl font-bold mb-10 flex items-center">
                    <i class="fas fa-clipboard-list text-yellow-500 mr-4"></i>Strategie di Recupero
                </h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="flex gap-6 p-6 rounded-2xl bg-white/5 hover:bg-white/10 transition border border-white/5 interactive">
                        <div class="flex-shrink-0 w-14 h-14 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-2xl shadow-lg">
                            <i class="fas fa-pause"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-xl mb-2">Recupero in Itinere</h4>
                            <p class="text-sm leading-relaxed opacity-80">Attivazione della <strong>Pausa Didattica</strong>. Sospensione temporanea del programma per consolidare i prerequisiti fondamentali.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 p-6 rounded-2xl bg-white/5 hover:bg-white/10 transition border border-white/5 interactive">
                        <div class="flex-shrink-0 w-14 h-14 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-2xl shadow-lg">
                            <i class="fas fa-hands-helping"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-xl mb-2">Sportello "Help"</h4>
                            <p class="text-sm leading-relaxed opacity-80">Interventi mirati pomeridiani su prenotazione. Focus su discipline critiche: <strong>Matematica, Inglese, Scienze</strong>.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 p-6 rounded-2xl bg-white/5 hover:bg-white/10 transition border border-white/5 interactive">
                        <div class="flex-shrink-0 w-14 h-14 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 text-2xl shadow-lg">
                            <i class="fas fa-book-reader"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-xl mb-2">Studio Guidato</h4>
                            <p class="text-sm leading-relaxed opacity-80">Assegnazione di materiale strutturato per lo studio autonomo, con monitoraggio puntuale dei progressi.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 p-6 rounded-2xl bg-white/5 hover:bg-white/10 transition border border-white/5 interactive">
                        <div class="flex-shrink-0 w-14 h-14 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400 text-2xl shadow-lg">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-xl mb-2">Peer Tutoring</h4>
                            <p class="text-sm leading-relaxed opacity-80">Valorizzazione delle eccellenze: studenti del triennio supportano i compagni in difficoltà (crediti/PCTO).</p>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="text-center pb-8 pt-10 text-xs border-t border-white/10 mt-10 opacity-60">
                &copy; 2026 IIS Mendel - Pagina creata dal Team Digitale per il collegio docenti
            </footer>

        </div>
    </main>

    <script id="embedded-data-script">
        window.EMBEDDED_DATA = null;
        window.EMBEDDED_SUBJECTS = null;
    </script>

    <script>
        let GLOBAL_DATA_STORE = {};
        let GLOBAL_SUBJECT_STORE = {};
        let GLOBAL_EXPORT_DATA = [];
        let GLOBAL_STATS = {};
        let IS_LIGHT_MODE = false;

        function toggleTheme() {
            IS_LIGHT_MODE = !IS_LIGHT_MODE;
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            if (IS_LIGHT_MODE) {
                body.classList.add('light-mode');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                body.classList.remove('light-mode');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }

            const textColor = IS_LIGHT_MODE ? '#333333' : '#ffffff';
            const gridColor = IS_LIGHT_MODE ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.05)';
            const titleColor = IS_LIGHT_MODE ? '#1e3a8a' : '#ffffff';
            
            Highcharts.charts.forEach(chart => {
                if (chart) {
                    chart.update({
                        chart: { style: { color: textColor } },
                        title: { style: { color: titleColor } },
                        legend: { 
                            itemStyle: { color: textColor },
                            itemHoverStyle: { color: textColor }
                        },
                        xAxis: { 
                            gridLineColor: gridColor,
                            lineColor: gridColor,
                            labels: { style: { color: textColor } }
                        },
                        yAxis: { 
                            gridLineColor: gridColor,
                            labels: { style: { color: textColor } },
                            title: { style: { color: textColor } }
                        },
                        plotOptions: {
                            column: { dataLabels: { color: IS_LIGHT_MODE ? 'black' : 'white' } },
                            bar: { dataLabels: { color: IS_LIGHT_MODE ? 'black' : 'white' } }
                        }
                    });
                }
            });
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64.split(',')[1]);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function toggleDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('save-btn-container');
            dropdown.classList.toggle('dropdown-open');
        }

        function closeDropdown() {
            const dropdown = document.getElementById('save-btn-container');
            dropdown.classList.remove('dropdown-open');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('save-btn-container');
            const isClickInside = dropdown ? dropdown.contains(event.target) : false;
            if (dropdown && !isClickInside) {
                closeDropdown();
            }
        });

        window.onload = function() {
            if (window.EMBEDDED_DATA && window.EMBEDDED_SUBJECTS) {
                renderDashboard(window.EMBEDDED_DATA, window.EMBEDDED_SUBJECTS);
            }
        };

        Highcharts.setOptions({
            colors: ['#3b82f6', '#f59e0b', '#ef4444', '#6366f1', '#8b5cf6'],
            chart: {
                backgroundColor: 'rgba(0,0,0,0)',
                style: { fontFamily: 'Roboto, sans-serif', color: '#fff' },
                zoomType: 'x',
                panning: true,
                panKey: 'shift'
            },
            title: { style: { color: '#fff', fontWeight: 'bold' } },
            legend: { 
                itemStyle: { color: '#e2e8f0', fontWeight: '500' }, 
                itemHoverStyle: { color: '#fff' },
                backgroundColor: 'rgba(0,0,0,0.1)',
                borderRadius: 10
            },
            xAxis: { 
                gridLineColor: 'rgba(255,255,255,0.05)', 
                labels: { style: { color: '#cbd5e1', fontSize: '12px' } },
                lineColor: 'rgba(255,255,255,0.1)'
            },
            yAxis: { 
                gridLineColor: 'rgba(255,255,255,0.05)', 
                labels: { style: { color: '#cbd5e1' } },
                title: { style: { color: '#cbd5e1' } }
            },
            plotOptions: {
                column: {
                    depth: 60,
                    edgeColor: 'rgba(255,255,255,0.1)',
                    edgeWidth: 1,
                    groupZPadding: 20,
                    grouping: false,
                    borderRadius: 2,
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function() {
                                const chart = this.series.chart;
                                const index = this.index;
                                const min = Math.max(0, index - 1);
                                const max = Math.min(chart.xAxis[0].max, index + 1);
                                chart.xAxis[0].setExtremes(min, max);

                                if (!chart.resetZoomBtn) {
                                    chart.resetZoomBtn = chart.renderer.button(
                                        'Ripristina Zoom ↺', 
                                        chart.plotWidth - 140, 
                                        10, 
                                        function () {
                                            chart.xAxis[0].setExtremes(null, null);
                                            chart.resetZoomBtn.destroy();
                                            chart.resetZoomBtn = null;
                                        }, 
                                        { zIndex: 10, fill: '#3b82f6', style: { color: 'white', fontWeight: 'bold' } }
                                    ).add();
                                }
                            }
                        }
                    }
                }
            },
            credits: { enabled: false }
        });

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const errorMsg = document.getElementById('error-msg');
        const successMsg = document.getElementById('success-msg');
        
        if (dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('drag-active'), false));
            ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('drag-active'), false));
            dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        }
        if (fileInput) fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        async function handleFiles(files) {
            if (files.length === 0) return;
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');
            
            const rawClassData = {}; 
            let validFilesFound = 0;

            successMsg.innerText = `Elaborazione in corso...`;
            successMsg.classList.remove('hidden');

            const readFile = (file) => {
                return new Promise((resolve) => {
                    const nameMatch = file.name.match(/(\d+)[\s\^]*([A-Z]+)/i);
                    if (!nameMatch) { resolve(); return; }

                    const className = (nameMatch[1] + nameMatch[2]).toUpperCase();
                    if (!rawClassData[className]) rawClassData[className] = [];

                    const fileName = file.name.toLowerCase();
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        let rows = [];
                        try {
                            if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, {type: 'array'});
                                rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                            } else if (fileName.endsWith('.csv')) {
                                rows = e.target.result.split('\n').map(row => row.split(/,|;/));
                            }
                            if (rows.length > 0) {
                                rawClassData[className].push({ rows: rows });
                                validFilesFound++;
                            }
                        } catch (err) { console.error(err); }
                        resolve();
                    };

                    if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) reader.readAsArrayBuffer(file);
                    else if (fileName.endsWith('.csv')) reader.readAsText(file);
                    else resolve();
                });
            };

            await Promise.all(Array.from(files).map(readFile));

            if (validFilesFound === 0) {
                showError("Nessun file valido trovato.");
                return;
            }

            const processedData = {};
            const processedSubjects = {};
            const classesFoundDiv = document.getElementById('analyzed-classes');
            classesFoundDiv.innerHTML = '';

            Object.keys(rawClassData).forEach(className => {
                processedData[className] = [];
                processedSubjects[className] = {};
                const filesForClass = rawClassData[className];
                
                const badge = document.createElement('div');
                badge.className = "bg-white/10 p-2 rounded border border-white/20 shadow-sm";
                badge.innerHTML = `<span class="font-bold text-blue-300 block text-lg">${className}</span><span class="opacity-70">${filesForClass.length} file uniti</span>`;
                classesFoundDiv.appendChild(badge);

                let subjectNames = null;
                for (const fileObj of filesForClass) {
                    const found = findSubjectNamesAndIndex(fileObj.rows);
                    if (found) { subjectNames = found; break; }
                }

                if (subjectNames) {
                    filesForClass.forEach(fileObj => analyzeRowsByIndex(fileObj.rows, subjectNames, className, processedData, processedSubjects));
                }
            });

            renderDashboard(processedData, processedSubjects);
        }

        function findSubjectNamesAndIndex(rows) {
            let headerIndex = -1;
            for (let i = 0; i < Math.min(rows.length, 25); i++) {
                const rowStr = JSON.stringify(rows[i]).toUpperCase();
                if (rowStr.includes("ITALIANO") || rowStr.includes("MATEMATICA")) { 
                    headerIndex = i; 
                    break; 
                }
            }
            if (headerIndex === -1) return null;

            const row = rows[headerIndex];
            const subjects = []; 
            const exclude = ['PR.', 'ALUNNO', 'RELIGIONE', 'CONDOTTA', 'MEDIA', 'ESITO', 'CREDITI', 'ANNO SCOLASTICO', 'CLASSE:', 'NOTE', 'ASSENZE', 'DATA NASCITA', 'MEDIA VOTO', 'COMPORTAMENTO', 'ESITO FINALE', 'ORE PCTO'];

            for (let i = 0; i < row.length; i++) {
                const h = row[i] ? row[i].toString().trim().toUpperCase() : "";
                if (h && !exclude.includes(h) && !h.startsWith('UNNAMED') && h.length > 2) {
                    subjects.push({ name: h, index: i });
                }
            }
            return { subjects: subjects, headerIndex: headerIndex }; 
        }

        function analyzeRowsByIndex(rows, headerInfo, className, dataStore, subjectStore) {
            for (let i = headerInfo.headerIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 2) continue;

                let insuffCount = 0;
                let hasGrades = false;

                headerInfo.subjects.forEach(subj => {
                    const targetIndex = subj.index;
                    if (targetIndex < row.length) {
                        const val = row[targetIndex];
                        if (val !== undefined && val !== null && val.toString().trim() !== "") {
                            const valStr = val.toString().replace(',', '.').trim();
                            
                            if (valStr.toUpperCase() === 'NC') {
                                hasGrades = true;
                                insuffCount++;
                                if(!subjectStore[className][subj.name]) subjectStore[className][subj.name] = 0;
                                subjectStore[className][subj.name]++;
                            }
                            else if (!isNaN(parseFloat(valStr))) {
                                const numVal = parseFloat(valStr);
                                if (numVal > 0 && numVal <= 10) {
                                    hasGrades = true; 
                                    if (numVal < 6.0) {
                                        insuffCount++;
                                        if(!subjectStore[className][subj.name]) subjectStore[className][subj.name] = 0;
                                        subjectStore[className][subj.name]++;
                                    }
                                }
                            }
                        }
                    }
                });

                if (hasGrades) {
                    dataStore[className].push(insuffCount);
                }
            }
        }

        function renderDashboard(dataStore, subjectStore) {
            GLOBAL_DATA_STORE = dataStore;
            GLOBAL_SUBJECT_STORE = subjectStore;

            const intro = document.getElementById('intro-hero');
            if(intro) intro.style.display = 'none';
            document.getElementById('report-content').classList.remove('hidden');
            if(document.getElementById('print-btn')) document.getElementById('print-btn').classList.remove('hidden');
            if(document.getElementById('save-btn-container')) {
                document.getElementById('save-btn-container').classList.remove('hidden');
                document.getElementById('save-btn-container').classList.add('inline-block');
            }

            const classes = Object.keys(dataStore).sort();
            
            GLOBAL_EXPORT_DATA = [];
            classes.forEach(cls => {
                const students = dataStore[cls];
                let c0=0, c12=0, c3p=0;
                students.forEach(d => { if (d===0) c0++; else if(d<=2) c12++; else c3p++; });
                GLOBAL_EXPORT_DATA.push({ Classe: cls, Totale_Alunni: students.length, Nessuna_Insufficienza: c0, Insufficienze_1_2: c12, Insufficienze_3_piu: c3p });
            });

            const parallelData = { 'Prime': { '1-2': 0, '3+': 0 }, 'Seconde': { '1-2': 0, '3+': 0 }, 'Terze': { '1-2': 0, '3+': 0 }, 'Quarte': { '1-2': 0, '3+': 0 }, 'Quinte': { '1-2': 0, '3+': 0 } };
            const chartClassCategories = [];
            const series0 = [], series12 = [], series3p = [];
            let total = 0, clean = 0, debt = 0;

            classes.forEach(cls => {
                const students = dataStore[cls];
                let c0=0, c12=0, c3p=0;
                students.forEach(d => {
                    total++;
                    if (d===0) { c0++; clean++; } else { debt++; if(d<=2) c12++; else c3p++; }
                });
                const yearKey = {'1':'Prime','2':'Seconde','3':'Terze','4':'Quarte','5':'Quinte'}[cls.charAt(0)];
                if(yearKey) { parallelData[yearKey]['1-2'] += c12; parallelData[yearKey]['3+'] += c3p; }
                chartClassCategories.push(cls); series0.push(c0); series12.push(c12); series3p.push(c3p);
            });

            document.getElementById('stat-total-students').innerText = total;
            document.getElementById('stat-clean-students').innerText = clean;
            document.getElementById('stat-debt-students').innerText = debt;
            if(total > 0) {
                document.getElementById('perc-clean').innerText = Math.round((clean/total)*100) + "% del totale";
                document.getElementById('perc-debt').innerText = Math.round((debt/total)*100) + "% del totale";
            }
            GLOBAL_STATS = { total, clean, debt };

            const pCats = Object.keys(parallelData).filter(k => (parallelData[k]['1-2'] + parallelData[k]['3+']) > 0);
            Highcharts.chart('chart-parallel', {
                chart: { type: 'column', options3d: { enabled: true, alpha: 15, beta: 15, depth: 70, viewDistance: 25 } },
                title: { text: null }, xAxis: { categories: pCats }, yAxis: { title: { text: 'N. Studenti' }, allowDecimals: false },
                plotOptions: { column: { depth: 50, stacking: 'normal', dataLabels: { enabled: true, color: 'white', style: { textOutline: 'none' } } } },
                series: [{ name: 'Gravi (3+ materie)', data: pCats.map(c => parallelData[c]['3+']), color: '#ef4444' }, { name: 'Lievi (1-2 materie)', data: pCats.map(c => parallelData[c]['1-2']), color: '#f59e0b' }]
            });

            Highcharts.chart('chart-classes', {
                chart: { type: 'column', options3d: { enabled: true, alpha: 10, beta: 25, depth: 80, viewDistance: 25 } },
                title: { text: null }, xAxis: { categories: chartClassCategories }, yAxis: { title: { text: 'Numero Alunni' }, allowDecimals: false },
                plotOptions: { column: { depth: 45, stacking: 'normal' } },
                series: [{ name: '3+ Insuff.', data: series3p, color: '#ef4444' }, { name: '1-2 Insuff.', data: series12, color: '#f59e0b' }, { name: '0 Insuff.', data: series0, color: '#3b82f6' }]
            });

            const parallelSubjects = { 'Prime': {}, 'Seconde': {}, 'Terze': {}, 'Quarte': {}, 'Quinte': {} };
            Object.keys(subjectStore).forEach(cls => {
                const yearKey = {'1':'Prime','2':'Seconde','3':'Terze','4':'Quarte','5':'Quinte'}[cls.charAt(0)];
                if (yearKey) {
                    Object.keys(subjectStore[cls]).forEach(subj => {
                        if (!parallelSubjects[yearKey][subj]) parallelSubjects[yearKey][subj] = 0;
                        parallelSubjects[yearKey][subj] += subjectStore[cls][subj];
                    });
                }
            });

            const parallelContainer = document.getElementById('parallel-subjects-container');
            parallelContainer.innerHTML = '';
            Object.keys(parallelSubjects).forEach(yearKey => {
                const subjects = parallelSubjects[yearKey];
                const labels = Object.keys(subjects).filter(s => subjects[s] > 0);
                if (labels.length > 0) {
                     labels.sort((a, b) => subjects[b] - subjects[a]);
                     const chartWrapper = document.createElement('div');
                     chartWrapper.className = 'glass-panel p-6 rounded-3xl interactive'; 
                     chartWrapper.innerHTML = `<h4 class="text-xl font-bold mb-4 flex items-center"><span class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center mr-3 text-cyan-400 text-sm"><i class="fas fa-layer-group"></i></span> Classi ${yearKey}</h4><div style="height: 350px; width: 100%;"></div>`;
                     parallelContainer.appendChild(chartWrapper);
                     Highcharts.chart(chartWrapper.querySelector('div'), {
                        chart: { type: 'column', options3d: { enabled: true, alpha: 10, beta: 15, depth: 50, viewDistance: 25 } },
                        title: { text: null }, xAxis: { categories: labels, labels: { style: { color: '#cbd5e1', fontSize: '11px' }, rotation: -45 } },
                        yAxis: { title: { text: 'Totale Insufficienze' }, allowDecimals: false }, legend: { enabled: false },
                        plotOptions: { column: { depth: 40, colorByPoint: true, colors: ['#06b6d4', '#22d3ee', '#67e8f9', '#a5f3fc'] } },
                        series: [{ name: 'Insufficienze', data: labels.map(s => subjects[s]) }]
                    });
                }
            });

            const container = document.getElementById('subject-charts-container');
            container.innerHTML = '';
            classes.forEach(cls => {
                const subjects = subjectStore[cls];
                const labels = Object.keys(subjects).filter(s => subjects[s] > 0);
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'glass-panel p-6 rounded-3xl interactive'; 
                chartWrapper.innerHTML = `<h4 class="text-xl font-bold mb-4 flex items-center"><span class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center mr-3 text-indigo-400 text-sm">${cls}</span> Materie Critiche</h4><div style="height: 300px; width: 100%;"></div>`;
                container.appendChild(chartWrapper);
                if (labels.length > 0) {
                    Highcharts.chart(chartWrapper.querySelector('div'), {
                        chart: { type: 'column', options3d: { enabled: true, alpha: 10, beta: 25, depth: 70, viewDistance: 25 } },
                        title: { text: null }, xAxis: { categories: labels, labels: { style: { color: '#cbd5e1', fontSize: '10px' }, rotation: -45 } },
                        yAxis: { title: { text: 'N. Insufficienze' }, allowDecimals: false }, legend: { enabled: false },
                        plotOptions: { column: { depth: 40, colorByPoint: true, colors: ['#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e'] } },
                        series: [{ name: 'Insufficienze', data: labels.map(s => subjects[s]) }]
                    });
                } else {
                    chartWrapper.querySelector('div').innerHTML = '<div class="flex items-center justify-center h-full text-blue-300 italic">Nessuna insufficienza rilevata</div>';
                }
            });

            // --- NUOVA SEZIONE: CALCOLO PERCENTUALE TOTALE PER MATERIA ---
            let totalStudentsAll = 0;
            const subjectsAll = {};

            // 1. Contiamo tutti gli studenti e uniamo tutte le insufficienze
            classes.forEach(cls => {
                const studentsCount = dataStore[cls] ? dataStore[cls].length : 0;
                totalStudentsAll += studentsCount;

                const subjects = subjectStore[cls] || {};
                Object.keys(subjects).forEach(subj => {
                    if (!subjectsAll[subj]) subjectsAll[subj] = 0;
                    subjectsAll[subj] += subjects[subj];
                });
            });

            // 2. Prepariamo i dati calcolando le percentuali
            const labelsMaterie = Object.keys(subjectsAll).filter(s => subjectsAll[s] > 0);
            
            // Ordiniamo in modo decrescente (la materia con più insufficienze sarà in alto)
            labelsMaterie.sort((a, b) => subjectsAll[b] - subjectsAll[a]); 
            
            const dataMaterie = labelsMaterie.map(s => {
                let perc = totalStudentsAll > 0 ? (subjectsAll[s] / totalStudentsAll) * 100 : 0;
                return parseFloat(perc.toFixed(1)); // Arrotonda a 1 decimale
            });

            // 3. Disegniamo il grafico a barre orizzontali
            const containerPerc = document.getElementById('chart-perc-materie');
            if (containerPerc) {
                if (labelsMaterie.length > 0) {
                    Highcharts.chart('chart-perc-materie', {
                        chart: { 
                            type: 'bar', 
                            backgroundColor: 'transparent',
                            options3d: { enabled: true, alpha: 0, beta: 0, depth: 20, viewDistance: 25 },
                            zoomType: 'xy' // Abilita lo zoom con selezione del mouse
                        },
                        title: { text: null },
                        xAxis: { 
                            categories: labelsMaterie, 
                            labels: { style: { color: IS_LIGHT_MODE ? '#333' : '#cbd5e1', fontSize: '11px', fontWeight: 'bold' } } 
                        },
                        yAxis: { 
                            title: { text: '% Alunni con insufficienza', style: { color: IS_LIGHT_MODE ? '#333' : '#cbd5e1' } }, 
                            max: 100, 
                            labels: { format: '{value}%', style: { color: IS_LIGHT_MODE ? '#333' : '#cbd5e1' } },
                            gridLineColor: IS_LIGHT_MODE ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.05)'
                        },
                        legend: { enabled: false },
                        plotOptions: { 
                            bar: { 
                                colorByPoint: true,
                                depth: 25,
                                cursor: 'pointer', // Cursore a manina per indicare la cliccabilità
                                dataLabels: { 
                                    enabled: true, 
                                    format: '{point.y}%', 
                                    color: IS_LIGHT_MODE ? 'black' : 'white', 
                                    style: { textOutline: 'none', fontWeight: 'bold' }
                                },
                                point: {
                                    events: {
                                        click: function() {
                                            const chart = this.series.chart;
                                            const index = this.index;
                                            
                                            // Zoom che mostra la barra cliccata e le 2 sopra/sotto
                                            const min = Math.max(0, index - 2);
                                            const max = Math.min(chart.xAxis[0].categories.length - 1, index + 2);
                                            chart.xAxis[0].setExtremes(min, max);

                                            if (!chart.resetZoomBtn) {
                                                chart.resetZoomBtn = chart.renderer.button(
                                                    'Ripristina Zoom ↺', 
                                                    chart.plotWidth - 140, 
                                                    10, 
                                                    function () {
                                                        chart.xAxis[0].setExtremes(null, null);
                                                        chart.resetZoomBtn.destroy();
                                                        chart.resetZoomBtn = null;
                                                    }, 
                                                    { zIndex: 10, fill: '#3b82f6', style: { color: 'white', fontWeight: 'bold' } }
                                                ).add();
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        // Colori in linea con la dashboard: toni del blu, indaco, viola, ciano
                        colors: ['#3b82f6', '#6366f1', '#8b5cf6', '#0ea5e9', '#06b6d4'],
                        series: [{ name: '% Insufficienze', data: dataMaterie }]
                    });
                } else {
                    containerPerc.innerHTML = '<div class="flex items-center justify-center h-full text-blue-300 italic">Nessun dato calcolabile per le materie</div>';
                }
            }
            // --- FINE NUOVA SEZIONE ---    
        }
        
        function exportHTML() {
            if (Object.keys(GLOBAL_DATA_STORE).length === 0) {
                alert("Nessun dato da esportare. Carica prima i file.");
                return;
            }
            const currentHTML = document.documentElement.outerHTML;
            const dataString = JSON.stringify(GLOBAL_DATA_STORE);
            const subjectsString = JSON.stringify(GLOBAL_SUBJECT_STORE);
            let exportedContent = currentHTML.replace(/window\.EMBEDDED_DATA\s*=\s*null;/, `window.EMBEDDED_DATA = ${dataString};`);
            exportedContent = exportedContent.replace(/window\.EMBEDDED_SUBJECTS\s*=\s*null;/, `window.EMBEDDED_SUBJECTS = ${subjectsString};`);
            const blob = new Blob([exportedContent], { type: 'text/html' });
            saveAs(blob, "Report_Scrutini_Professionale_Statico.html");
        }

        function exportXLSX() {
            if (GLOBAL_EXPORT_DATA.length === 0) return;
            const worksheet = XLSX.utils.json_to_sheet(GLOBAL_EXPORT_DATA);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Dati Scrutini");
            XLSX.writeFile(workbook, 'Report_Scrutini_Professionale_Statico.xlsx');
        }

        function exportCSV() {
            if (GLOBAL_EXPORT_DATA.length === 0) return;
            const worksheet = XLSX.utils.json_to_sheet(GLOBAL_EXPORT_DATA);
            const csv = XLSX.utils.sheet_to_csv(worksheet);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, 'Report_Scrutini_Professionale.csv');
        }

        async function exportDOCX() {
            if (GLOBAL_EXPORT_DATA.length === 0) return;
            const btn = document.querySelector('#save-btn-container button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generazione...';

            try {
                const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, HeadingLevel, ImageRun, TextRun } = docx;
                const tableRows = [new TableRow({ children: [new TableCell({ children: [new Paragraph({ text: "Classe", bold: true })] }), new TableCell({ children: [new Paragraph({ text: "Tot. Alunni", bold: true })] }), new TableCell({ children: [new Paragraph({ text: "Nessuna Insuff.", bold: true })] }), new TableCell({ children: [new Paragraph({ text: "1-2 Insuff.", bold: true })] }), new TableCell({ children: [new Paragraph({ text: "3+ Insuff.", bold: true })] })]})];
                GLOBAL_EXPORT_DATA.forEach(row => { tableRows.push(new TableRow({ children: [new TableCell({ children: [new Paragraph(row.Classe)] }), new TableCell({ children: [new Paragraph(row.Totale_Alunni.toString())] }), new TableCell({ children: [new Paragraph(row.Nessuna_Insufficienza.toString())] }), new TableCell({ children: [new Paragraph(row.Insufficienze_1_2.toString())] }), new TableCell({ children: [new Paragraph(row.Insufficienze_3_piu.toString())] })]})); });

                const chartImages = [];
                const captureElement = async (id, title) => {
                    const el = document.getElementById(id);
                    if (el) {
                        const bgColor = IS_LIGHT_MODE ? '#ffffff' : '#172554';
                        const canvas = await html2canvas(el, { scale: 2, backgroundColor: bgColor });
                        chartImages.push({ title: title, data: canvas.toDataURL("image/png") });
                    }
                };

                await captureElement('container-chart-parallel', 'Andamento Classi Parallele');
                await captureElement('container-chart-classes', 'Dettaglio Studenti per Classe');

                const docChildren = [new Paragraph({ text: "Report Scrutini - Istituto Professionale Mendel", heading: HeadingLevel.HEADING_1, spacing: { after: 300 } }), new Paragraph({ text: `Totale Alunni: ${GLOBAL_STATS.total} | Senza Debiti: ${GLOBAL_STATS.clean} | Con Insufficienze: ${GLOBAL_STATS.debt}`, spacing: { after: 300 } }), new Paragraph({ text: "Tabella Sintetica Dati", heading: HeadingLevel.HEADING_2, spacing: { after: 200 } }), new Table({ rows: tableRows, width: { size: 100, type: WidthType.PERCENTAGE } }), new Paragraph({ text: "", spacing: { after: 400 } }), new Paragraph({ text: "Grafici e Analisi Visiva", heading: HeadingLevel.HEADING_2, spacing: { after: 200 } })];
                chartImages.forEach(img => { docChildren.push(new Paragraph({ children: [new TextRun({ text: img.title, bold: true, size: 24 })], spacing: { before: 400, after: 100 } })); docChildren.push(new Paragraph({ children: [new ImageRun({ data: base64ToArrayBuffer(img.data), transformation: { width: 550, height: 350 }, type: "png" })], spacing: { after: 200 } })); });

                const doc = new Document({ sections: [{ children: docChildren }] });
                const blob = await Packer.toBlob(doc);
                saveAs(blob, "Report_Scrutini_Professionale_Completo.docx");
            } catch (err) { console.error(err); alert("Errore generazione Word: " + err.message); } finally { btn.innerHTML = originalText; }
        }
    </script>
</body>
</html>
